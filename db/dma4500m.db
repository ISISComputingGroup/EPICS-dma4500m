record(ao, "$(P):set_temperature") {
  field(DESC, "Sample temperature")
  field(DTYP, "stream")
  field(OUT, "@dma4500m.protocol set_temperature $(PORT)")
  field(EGU, "C")
  field(PREC, "2")
  field(DRVL, "0")
  field(DRVH, "90")
  field(DISV, "1")
  field(DISA, "0")
  field(SDIS, "$(P):measuring")
}

record(bo, "$(P):start") {
  field(DESC, "Start measuring")
  field(DTYP, "stream")
  field(OUT, "@dma4500m.protocol start $(PORT)")
  field(DISV, "1")
  field(SDIS, "$(P):measuring")
  field(FLNK, "$(P):start_measuring")
}

## set to > 0 for auto measurement
record(longin, "$(P):automeasure:time")
{
    field(VAL, 0)
    info(autosaveFields, "VAL")
}

record(calcout, "$(P):automeasure")
{
  field(INPA, "$(P):automeasure:time NPP")
  field(CALC, "A=0?1:(B:=(B=0?A:B-1);B)")
  field(OOPT, "When Zero")
  field(DOPT, "1")
  field(OUT, "$(P):start PP")
  field(SDIS, "$(P):measuring")
  field(DISV, "1")
  field(SCAN, "1 second")
}

record(fanout, "$(P):start_measuring") {
  field(LNK1, "$(P):update_flags")
  field(LNK2, "$(P):finished")
}

record(fanout, "$(P):update_flags") {
  field(LNK1, "$(P):measuring")
  field(LNK2, "$(P):data_available")
}

record(calc, "$(P):measuring") {
  field(INPA, "$(P):start")
  field(INPB, "$(P):finished")
  field(CALC, "A == 1 || B == 1")
  field(FLNK, "$(P):reset_start")
  field(archive, "VAL")
}

record(bo, "$(P):reset_start") {
  field(VAL, "0")
  field(OUT, "$(P):start.VAL")
}

record(calc, "$(P):data_available") {
  field(INPA, "$(P):finished")
  field(CALC, "A == 2")
  field(FLNK, "$(P):get_data")
}

record(mbbi, "$(P):finished") {
  field(DESC, "Measurement status")
  field(DTYP, "stream")
  field(INP, "@dma4500m.protocol finished $(PORT)")
  field(ZRVL, "0")
  field(ONVL, "1")
  field(TWVL, "2")
  field(ZRST, "not started")
  field(ONST, "not finished")
  field(TWST, "finished")
  field(SCAN, "2 second")
  field(DISA, "0")
  field(DISV, "0")
  field(SDIS, "$(P):measuring")
  field(FLNK, "$(P):update_flags")
}


record(bo, "$(P):get_data") {
  field(DESC, "Read sample data from device")
  field(DTYP, "stream")
  field(OUT, "@dma4500m.protocol get_data $(PORT)")
  field(SDIS, "$(P):data_available")
  field(DISA, "0")
  field(DISV, "0")
  field(FLNK, "$(P):reset")
}

record(fanout, "$(P):reset") {
  field(LNK1, "$(P):reset_finished")
  field(LNK2, "$(P):update_flags")
}

record(ao, "$(P):reset_finished") {
  field(VAL, "0")
  field(OUT, "$(P):finished.VAL")
  field(FLNK, "$(P):finished")
}

record(ai, "$(P):temperature") {
  field(DESC, "Sample temperature")
  field(DTYP, "stream")
  field(INP, "@dma4500m.protocol temperature $(PORT)")
  field(SCAN, "I/O Intr")
  field(EGU, "C")
  field(PREC, "2")
  field(archive, "VAL")
}

record(ai, "$(P):density") {
  field(DESC, "Sample density")
  field(DTYP, "stream")
  field(INP, "@dma4500m.protocol density $(PORT)")
  field(SCAN, "I/O Intr")
  field(EGU, "g/cm^3")
  field(PREC, "5")
  field(archive, "VAL")
}
